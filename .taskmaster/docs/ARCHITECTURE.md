# DesktopMate+ Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     USER INTERACTION LAYER                       â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Open-LLM-VTuber-Web (Electron + React)          â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚  â”‚ Live2D   â”‚  â”‚   Chat   â”‚  â”‚ Settings â”‚              â”‚   â”‚
â”‚  â”‚  â”‚  Model   â”‚  â”‚    UI    â”‚  â”‚    UI    â”‚              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚         Audio Playback + Lip Sync Engine        â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ WebSocket + HTTP
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INTEGRATION LAYER                             â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              DesktopMate Adapter Service                 â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚  Message    â”‚  â”‚    TTS      â”‚  â”‚    VLM      â”‚     â”‚   â”‚
â”‚  â”‚  â”‚ Translator  â”‚  â”‚  Handler    â”‚  â”‚  Handler    â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚     WebSocket Message Queue & Handler            â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ REST API + WebSocket
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND SERVICE LAYER                          â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         DesktopMatePlus Backend (FastAPI)                â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚         WebSocket Gateway Service                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - Connection Management                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - Authorization                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - Heartbeat (ping/pong)                         â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚   Agent     â”‚  â”‚    TTS      â”‚  â”‚    VLM      â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚     â”‚   â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚     â”‚   â”‚
â”‚  â”‚  â”‚ - Streaming â”‚  â”‚ - Kokoro    â”‚  â”‚ - Vision    â”‚     â”‚   â”‚
â”‚  â”‚  â”‚ - LLM Chat  â”‚  â”‚ - Voice     â”‚  â”‚ - Analysis  â”‚     â”‚   â”‚
â”‚  â”‚  â”‚ - Tools     â”‚  â”‚ - Synth     â”‚  â”‚             â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚   â”‚
â”‚  â”‚  â”‚    STM      â”‚  â”‚    LTM      â”‚                       â”‚   â”‚
â”‚  â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚                       â”‚   â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚                       â”‚   â”‚
â”‚  â”‚  â”‚ - Sessions  â”‚  â”‚ - Long-term â”‚                       â”‚   â”‚
â”‚  â”‚  â”‚ - History   â”‚  â”‚   Memory    â”‚                       â”‚   â”‚
â”‚  â”‚  â”‚ - MongoDB   â”‚  â”‚             â”‚                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     EXTERNAL SERVICES                             â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   OpenAI    â”‚  â”‚   MongoDB   â”‚  â”‚  ONNX/ML    â”‚             â”‚
â”‚  â”‚     API     â”‚  â”‚  Database   â”‚  â”‚   Models    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Message Flow Diagram

### Scenario: User Sends "Hello, how are you?"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          â”‚                                              â”‚          â”‚
â”‚ Frontend â”‚                                              â”‚ Backend  â”‚
â”‚          â”‚                                              â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                                         â”‚
     â”‚  1. User types message                                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                         â”‚
     â”‚  2. WebSocket: authorize                               â”‚
     â”‚     { type: "authorize", token: "demo-token" }         â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚                                                         â”‚
     â”‚  3. authorize_success                                  â”‚
     â”‚     { type: "authorize_success", connection_id: "..." }â”‚
     <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                         â”‚
     â”‚  4. User clicks send                                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                         â”‚
     â”‚  5. WebSocket: chat_message                            â”‚
     â”‚     { type: "chat_message",                            â”‚
     â”‚       messages: [{ type: "human",                      â”‚
     â”‚                    content: "Hello, how are you?" }] } â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚                                                         â”‚
     â”‚                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                            â”‚ Process    â”‚
     â”‚                                            â”‚ with LLM   â”‚
     â”‚                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                         â”‚
     â”‚  6. stream_start                                       â”‚
     <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                         â”‚
     â”œâ”€â”€â” Adapter converts to:                                â”‚
     â”‚  â”‚ { type: "control",                                  â”‚
     â”‚<â”€â”˜   text: "conversation-chain-start" }                â”‚
     â”‚                                                         â”‚
     â”œâ”€â”€â” UI shows "thinking" state                           â”‚
     â”‚<â”€â”˜                                                      â”‚
     â”‚                                                         â”‚
     â”‚                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                            â”‚ Generate   â”‚
     â”‚                                            â”‚ "Hello!"   â”‚
     â”‚                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                         â”‚
     â”‚  7. tts_ready_chunk #0                                 â”‚
     â”‚     { type: "tts_ready_chunk",                         â”‚
     â”‚       chunk: "Hello!",                                 â”‚
     â”‚       sentence_index: 0 }                              â”‚
     <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                         â”‚
     â”œâ”€â”€â” Adapter converts to:                                â”‚
     â”‚  â”‚ { type: "text", content: "Hello!",                  â”‚
     â”‚<â”€â”˜   _needs_tts: true }                                â”‚
     â”‚                                                         â”‚
     â”œâ”€â”€â” Call TTS API                                        â”‚
     â”‚  â”‚ POST /v1/tts/synthesize                             â”‚
     â”‚  â”‚ { text: "Hello!", reference_id: "ãƒŠãƒ„ãƒ¡" }         â”‚
     â”œâ”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚  â”‚                                                      â”‚
     â”‚  â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  â”‚                                         â”‚ Synthesize â”‚
     â”‚  â”‚                                         â”‚ Speech     â”‚
     â”‚  â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  â”‚                                                      â”‚
     â”‚  â”‚ TTS Response: { audio_data: "base64..." }           â”‚
     â”‚<â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  â”‚                                                      â”‚
     â”œ<â”€â”˜                                                      â”‚
     â”‚                                                         â”‚
     â”œâ”€â”€â” Extract volumes for lip-sync                        â”‚
     â”‚<â”€â”˜                                                      â”‚
     â”‚                                                         â”‚
     â”œâ”€â”€â” Add to audio queue                                  â”‚
     â”‚<â”€â”˜                                                      â”‚
     â”‚                                                         â”‚
     â”œâ”€â”€â” â–¶ Character speaks "Hello!"                         â”‚
     â”‚  â”‚   with lip-sync animation                           â”‚
     â”‚<â”€â”˜                                                      â”‚
     â”‚                                                         â”‚
     â”‚                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                            â”‚ Generate   â”‚
     â”‚                                            â”‚ "I'm well!"â”‚
     â”‚                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                         â”‚
     â”‚  8. tts_ready_chunk #1                                 â”‚
     â”‚     { type: "tts_ready_chunk",                         â”‚
     â”‚       chunk: "I'm doing well!",                        â”‚
     â”‚       sentence_index: 1 }                              â”‚
     <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                         â”‚
     â”œâ”€â”€â” Repeat TTS process...                               â”‚
     â”‚  â”‚ â–¶ Character continues speaking                      â”‚
     â”‚<â”€â”˜                                                      â”‚
     â”‚                                                         â”‚
     â”‚  9. stream_end                                         â”‚
     â”‚     { type: "stream_end",                              â”‚
     â”‚       full_response: "Hello! I'm doing well!" }        â”‚
     <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                         â”‚
     â”œâ”€â”€â” Adapter converts to:                                â”‚
     â”‚  â”‚ { type: "control",                                  â”‚
     â”‚<â”€â”˜   text: "conversation-chain-end" }                  â”‚
     â”‚                                                         â”‚
     â”œâ”€â”€â” UI shows "idle" state                               â”‚
     â”‚<â”€â”˜                                                      â”‚
     â”‚                                                         â”‚
     â”‚  10. Server sends ping                                 â”‚
     â”‚      { type: "ping" }                                  â”‚
     <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                         â”‚
     â”‚  11. Client responds pong                              â”‚
     â”‚      { type: "pong" }                                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚                                                         â”‚
     â–¼                                                         â–¼
```

## Data Flow: TTS Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   TTS STREAMING PIPELINE                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Backend                      Adapter                   Frontend
     â”‚                            â”‚                           â”‚
     â”‚ 1. LLM generates tokens    â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚
     â”‚                            â”‚                           â”‚
     â”‚ 2. Detect sentence end     â”‚                           â”‚
     â”‚    "Hello!"                â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚
     â”‚                            â”‚                           â”‚
     â”‚ 3. Send tts_ready_chunk    â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ 4. Convert to text event  â”‚
     â”‚                            â”‚    with _needs_tts flag   â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                           â”‚
     â”‚                            â”‚           5. Call TTS API â”‚
     â”‚                            â”‚              synthesize() â”‚
     â”‚ 6. TTS API Request         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚    POST /v1/tts/synthesize â”‚                           â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚                            â”‚                           â”‚
     â”‚ 7. Synthesize audio        â”‚                           â”‚
     â”‚    using Kokoro TTS        â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚
     â”‚                            â”‚                           â”‚
     â”‚ 8. Return base64 WAV       â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ 9. Extract volumes        â”‚
     â”‚                            â”‚    for lip-sync           â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                           â”‚
     â”‚                            â”‚          10. Add to queue â”‚
     â”‚                            â”‚              audioQueue   â”‚
     â”‚                            â”‚                           â”œâ”€â”€â”
     â”‚                            â”‚                           â”‚  â”‚
     â”‚                            â”‚                           â”‚<â”€â”˜
     â”‚                            â”‚                           â”‚
     â”‚                            â”‚          11. Play audio   â”‚
     â”‚                            â”‚              + lip-sync   â”‚
     â”‚                            â”‚                           â”œâ”€â”€â”
     â”‚                            â”‚                           â”‚â–¶ â”‚
     â”‚                            â”‚                           â”‚  â”‚
     â”‚                            â”‚                           â”‚<â”€â”˜
     â”‚                            â”‚                           â”‚
     â”‚ MEANWHILE...               â”‚                           â”‚
     â”‚ Continue streaming next    â”‚                           â”‚
     â”‚ sentence...                â”‚                           â”‚
     â”‚                            â”‚                           â”‚
```

## Component Interaction

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FRONTEND COMPONENTS                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocketContext â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ WebSocketService â”‚
â”‚                  â”‚         â”‚                  â”‚
â”‚ - wsUrl          â”‚         â”‚ - connect()      â”‚
â”‚ - baseUrl        â”‚         â”‚ - disconnect()   â”‚
â”‚ - sendMessage()  â”‚         â”‚ - sendMessage()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ uses
                                       â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ DesktopMateAdapter   â”‚
                          â”‚                      â”‚
                          â”‚ - adaptMessage()     â”‚
                          â”‚ - synthesizeSpeech() â”‚
                          â”‚ - analyzeImage()     â”‚
                          â”‚ - extractVolumes()   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                â”‚                â”‚
                    â–¼                â–¼                â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ TTS Service  â”‚  â”‚ VLM Service  â”‚  â”‚ STM Service  â”‚
          â”‚              â”‚  â”‚              â”‚  â”‚              â”‚
          â”‚ POST /v1/tts â”‚  â”‚ POST /v1/vlm â”‚  â”‚ GET/POST     â”‚
          â”‚ /synthesize  â”‚  â”‚ /analyze     â”‚  â”‚ /v1/stm/*    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocketHandler â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ AudioTaskQueue   â”‚
â”‚                  â”‚         â”‚                  â”‚
â”‚ - handle events  â”‚         â”‚ - addTask()      â”‚
â”‚ - call adapter   â”‚         â”‚ - clearQueue()   â”‚
â”‚ - trigger TTS    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                                       â”‚ feeds
                                       â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ Live2D Model         â”‚
                          â”‚                      â”‚
                          â”‚ - playAudio()        â”‚
                          â”‚ - setExpression()    â”‚
                          â”‚ - lipSync()          â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Structure

```
DesktopMatePlus/
â”‚
â”œâ”€â”€ backend/                           # Backend service
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ api/routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ websocket.py          # WebSocket endpoint
â”‚   â”‚   â”‚   â”œâ”€â”€ tts.py                # TTS API
â”‚   â”‚   â”‚   â”œâ”€â”€ vlm.py                # VLM API
â”‚   â”‚   â”‚   â””â”€â”€ stm.py                # STM API
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ websocket_service.py  # WebSocket manager
â”‚   â”‚   â”‚   â”œâ”€â”€ tts_service/          # TTS implementation
â”‚   â”‚   â”‚   â”œâ”€â”€ vlm_service/          # VLM implementation
â”‚   â”‚   â”‚   â””â”€â”€ stm_service/          # STM implementation
â”‚   â”‚   â””â”€â”€ main.py                   # FastAPI app
â”‚   â””â”€â”€ docs/api/                     # API documentation
â”‚
â”œâ”€â”€ Open-LLM-VTuber-Web/              # Frontend application
â”‚   â””â”€â”€ src/renderer/src/
â”‚       â”œâ”€â”€ context/
â”‚       â”‚   â””â”€â”€ websocket-context.tsx # WebSocket context
â”‚       â”œâ”€â”€ services/
â”‚       â”‚   â”œâ”€â”€ websocket-service.tsx # WebSocket client
â”‚       â”‚   â”œâ”€â”€ websocket-handler.tsx # Event handler
â”‚       â”‚   â””â”€â”€ desktopmate-adapter.tsx  # ğŸ†• Adapter service
â”‚       â”œâ”€â”€ config/
â”‚       â”‚   â””â”€â”€ desktopmate-config.ts    # ğŸ†• Configuration
â”‚       â””â”€â”€ components/
â”‚           â””â”€â”€ canvas/live2d/        # Live2D rendering
â”‚
â”œâ”€â”€ INTEGRATION_GUIDE.md              # ğŸ†• Full integration guide
â”œâ”€â”€ QUICK_INTEGRATION.md              # ğŸ†• Step-by-step guide
â”œâ”€â”€ README_INTEGRATION.md             # ğŸ†• Integration summary
â””â”€â”€ test_integration.sh               # ğŸ†• Test script
```

Legend: ğŸ†• = New files created for integration
